name: Push Build to Artifactory 

on: [push]

permissions:
  id-token: write  # Required for OIDC
  contents: read   # Required for actions/checkout

jobs:
  build:
    runs-on: ubuntu-latest
  
    steps:
      - name: Checkout Code 
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Download and Force Maven 3.8.8
        run: |
          # 1. Download the 3.8.8 binary directly from Apache archives
          wget -q https://archive.apache.org/dist/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz
          
          # 2. Extract the archive
          tar -xzf apache-maven-3.8.8-bin.tar.gz
          
          # 3. Prepend the new Maven bin directory to GITHUB_PATH
          # This ensures 'mvn' resolves to 3.8.8 instead of the system 3.9.12
          echo "$(pwd)/apache-maven-3.8.8/bin" >> $GITHUB_PATH

      - name: Set up JFrog CLI
        id: setup-jfrog-cli
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://migration1.jfrog.io
        with:
          oidc-provider-name: github-test
          oidc-audience: my-aud
          disable-auto-build-publish: false

      - name: Maven Build and Install
        run: |
          # Verify that the active Maven version is 3.8.8
          mvn -v
          
          # Configure the project for Artifactory
          jf mvnc --repo-resolve-releases test-libs-release \
                  --repo-resolve-snapshots test-libs-snapshot \
                  --repo-deploy-releases test-libs-release \
                  --repo-deploy-snapshots test-libs-snapshot
          
          # Run the build (JFrog CLI will now use the 3.8.8 version found in the path)
          jf mvn clean install -U -ntp -B
